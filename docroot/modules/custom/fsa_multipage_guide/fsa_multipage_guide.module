<?php

/**
 * @file
 * Library functions and hook implementations for FSA Multi page Guide module.
 */

use Symfony\Component\HttpFoundation\RedirectResponse;
use \Drupal\fsa_multipage_guide\FSAMultiPageGuide;
use Drupal\Core\Entity\EntityTypeInterface;

/**
 * Implements hook_entity_view().
 *
 * If you try and look at a multi page guide you get redirected to its first page.
 */
function fsa_multipage_guide_entity_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  \Drupal::logger('fsa_multipage_guide')->notice('In fsa_multipage_guide_entity_view().');
  if ($view_mode === 'full' && FSAMultiPageGuide::IsGuide($entity)) {
    \Drupal::logger('fsa_multipage_guide')->notice('Found the full view mode and it is a guide.');

    $parameters = \Drupal::routeMatch()->getParameters();

    if ($parameters->has('export_type')) {
      // PDF export in progress, do not redirect.
      \Drupal::logger('fsa_multipage_guide')->notice('Not redirecting due to being an export.');
      return;
    }

    $print_query = \Drupal::request()->query->get('print');

    if (!empty($print_query)) {
      // The special print query parameter means we want to print the page.
      \Drupal::logger('fsa_multipage_guide')->notice('Not redirecting due print query string.');
      return;
    }

    $guide = FSAMultiPageGuide::Get($entity);

    $first_page_url = $guide->getFirstPageUrl();

    if (!empty($first_page_url)) {
      \Drupal::logger('fsa_multipage_guide')->notice('Planning to send a redirect to ' . $first_page_url);
      $response = new RedirectResponse($first_page_url);
      $request = \Drupal::request();
      // Save the session so things like messages get saved.
      $request->getSession()->save();
      $response->prepare($request);
      // Make sure to trigger kernel events.
      \Drupal::service('kernel')->terminate($request, $response);
      \Drupal::logger('fsa_multipage_guide')->notice('Sending the redirect to ' . $first_page_url);
      $response->send();
    }

    \Drupal::logger('fsa_multipage_guide')->notice('Not redirecting as could not find first page.');
  }
}

/**
 * Implements hook_preprocess_field_node_title().
 */
function fsa_multipage_guide_preprocess_field__node__title(&$variables) {
  if (!empty($variables['element']['#object'])) {
    $guide = FSAMultiPageGuide::GetGuideForPage($variables['element']['#object']);
    if (!empty($guide)) {
      // Give the node title an extra class if its in a guide.
      $variables['attributes']['class'][] = 'guide__page__title';
    }
  }
}


/**
 * Implements hook_entity_bundle_field_info_alter().
 */
function fsa_multipage_guide_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  if ($entity_type->id() == 'node'  && !empty($fields['field_guide_pages'])) {
    $fields['field_guide_pages']->addConstraint('FSAPagesInGuide', []);
  }
}

