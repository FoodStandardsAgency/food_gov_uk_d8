<?php

/**
 * @file
 * Enables links to be referenced from a single managed source.
 */

use Drupal\Core\Render\BubbleableMetadata;
use Drupal\Core\Link;
use Drupal\Core\Url;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Component\Utility\Html;
use Drupal\Core\Cache\Cache;

/**
 * Implements hook_token_info().
 */
function fsa_managed_links_token_info() {

  // Get managed links.
  $data = _fsa_managed_links_data();

  // Generate tokens array.
  $tokens = [];
  foreach ($data['managed_links'] as $key => $link) {
    $tokens['managed_link'][$key] = [
      'name' => $link['name'],
      'description' => $link['url'],
      'needs-data' => 'managed_links',
    ];
  }

  // Provide token information.
  return [
    'types' => [
      'managed_link' => [
        'name' => t('Managed links'),
        'description' => t('Managed link tokens.'),
      ],
    ],
    'tokens' => $tokens,
  ];
}

/**
 * Implements hook_tokens().
 */
function fsa_managed_links_tokens($type, $tokens, array $data, array $options, BubbleableMetadata $bubbleable_metadata) {

  // Provide replacement values for tokens.
  $replacements = [];
  if ($type == 'managed_link') {
    foreach ($tokens as $key => $token) {
      $text = $data['managed_links'][$key]['text'];
      $url = $data['managed_links'][$key]['url'];
      $replacements[$token] = Link::fromTextAndUrl($text, Url::fromUri($url, []))->toString();
    }
  }
  return $replacements;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function fsa_managed_links_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {

  // Get managed links.
  $data = _fsa_managed_links_data();

  // Replace tokens with their replacement values.
  if ($build['#node']->hasField('body')) {
    $body = $build['#node']->get('body')->getValue();
    if (isset($body[0]['value'])) {
      $text = $body[0]['value'];
      $build['body'][0]['#text'] = \Drupal::token()->replace($text, $data);
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function fsa_managed_links_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  // Add token tree links under body widget.
  $form['body']['managed_links'] = array(
    '#theme' => 'token_tree_link',
    '#token_types' => ['managed_link'],
    '#global_types' => FALSE,
    '#text' => t('Insert managed link'),
  );
}

/**
 * Implements hook_form_alter().
 */
function fsa_managed_links_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  switch ($form_id) {

    // Add validation handler.
    case 'fsa_managed_link_add_form':
      $form['#validate'][] = 'fsa_managed_links_validate_name';
      break;

    // Prevent editing of name after inserted.
    case 'fsa_managed_link_edit_form':
      $form['name']['widget'][0]['value']['#type'] = 'hidden';
      break;
  }
}

/**
 * Managed link validation handler.
 */
function fsa_managed_links_validate_name(&$form, FormStateInterface $form_state) {
  if ($form_state->hasValue('name') && isset($form_state->getValue('name')[0]['value'])) {
    $value = $form_state->getValue('name')[0]['value'];

    // Compare user input against names already in use.
    $database = \Drupal::database();
    $name = $database->select('fsa_managed_link', 'f')
      ->fields('f', ['name'])
      ->condition('name', $database->escapeLike($value) . '%', 'LIKE')
      ->execute()
      ->fetchField();

    // Set error for any name already in use.
    if ($name) {
      $form_state->setErrorByName('name', t('The name <em>@name</em> is already in use.', [
        '@name' => $name,
      ]));
    }
  }
}

/**
 * Implements hook_entity_insert().
 */
function fsa_managed_links_entity_insert(EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'fsa_managed_link') {
    token_clear_cache();
  }
}

/**
 * Implements hook_entity_update().
 */
function fsa_managed_links_entity_update(EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'fsa_managed_link') {
    token_clear_cache();

    // Invalidate cached nodes.
    Cache::invalidateTags(['node_view']);
  }
}

/**
 * Implements hook_entity_delete().
 */
function fsa_managed_links_entity_delete(EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'fsa_managed_link') {
    token_clear_cache();
  }
}

/**
 * Implements template_preprocess_page_title().
 */
function fsa_managed_links_preprocess_page_title(&$variables) {
  if (isset($variables['title'])) {
    $title = $variables['title'];
    if (is_object($title) && method_exists($title, 'render')) {
      if ($variables['title']->render() == 'Add fsa managed link') {
        $variables['title'] = t('Add managed link');
      }
    }
  }
}

/**
 * Managed links data getter.
 */
function _fsa_managed_links_data() {

  // Load all managed links.
  $ids = \Drupal::entityQuery('fsa_managed_link')->execute();
  $managed_links = \Drupal::entityTypeManager()->getStorage('fsa_managed_link')
    ->loadMultiple($ids);

  // Push managed links onto structured array.
  $data['managed_links'] = [];
  foreach ($managed_links as $managed_link) {
    $name = $managed_link->getName();

    // Slugify name to form token key.
    $filter = [' ' => '_', '-' => '_', '/' => '_', '[' => '_', ']' => '_'];
    $name_slug = strtolower(Html::cleanCssIdentifier($name, $filter));
    $data['managed_links'][$name_slug] = [
      'name' => $name,
      'text' => $managed_link->get('field_managed_link_text')->getString(),
      'url' => $managed_link->get('field_managed_link_url')->getString(),
    ];
  };
  return $data;
}
