<?php

use Drupal\Component\Utility\Html;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_block_alter().
 *
 * Creates a copy of a search result view's exposed form block definition and
 * hands that to a custom block plugin which will only show relevant elements
 * on the search form.
 *
 * @param $info
 *
 * @see Drupal\fsa_es\Plugin\Block\ViewsExposedFilterSearchBlock
 */
function fsa_es_block_alter(&$info) {
  // @todo Make search delta discoverable.
  $search_view_exposed_block_delta = 'views_exposed_filter_block:search_global_ratings-page_1';

  if (isset($info[$search_view_exposed_block_delta])) {
    $info[$search_view_exposed_block_delta]['class'] = 'Drupal\fsa_es\Plugin\Block\ViewsExposedFilterSearchBlock';
  }
}

/**
 * Implements hook_views_pre_render().
 *
 * Sends Ajax-enabled views results total so that this could be displayed
 * in a separate block.
 */
function fsa_es_views_pre_render(ViewExecutable $view) {
  // If using AJAX, send identifying data about this view.
  if ($view->ajaxEnabled() && empty($view->live_preview)) {
    $view_element_selector = '.' . Html::getClass('views-result-total-' . $view->storage->id());

    $view->element['#attached']['library'][] = 'fsa_es/result_totals';
    $view->element['#attached']['drupalSettings']['fsa_es']['result_totals'] = [
      $view_element_selector => [
        'keywords' => isset($view->filter['keyword']) ? $view->filter['keyword']->value : NULL,
        'total' => $view->total_rows,
      ],
    ];
  }

  return $view;
}

/**
 * Implements hook_theme_suggestions_alter().
 *
 * Suggests a separate "block" template for views exposed filter blocks that
 * relate to search filters.
 *
 * Suggests a separate "views-view" template for global ratings search view.
 */
function fsa_es_theme_suggestions_alter(array &$suggestions, array $variables, $hook) {
  switch ($hook) {
    case 'block':
      // @todo Add block IDs that relate to global search filters.
      $block_ids = [
        'search_global_ratings_filters',
      ];

      if (in_array($variables['elements']['#id'], $block_ids, TRUE)) {
        $suggestions[] = 'block__' . $variables['elements']['#base_plugin_id'] . '__search_global_filters';
      }
      break;
    case 'views_view':
      $view = $variables['view'];

      if ($view->storage->id() == 'search_global_ratings') {
        $suggestions[] = 'views_view__' . $view->storage->id();
      }
      break;
  }

}
